#!/usr/bin/env bash

set -x

# Reset app-sandbox container:
rm -rf ~/Library/Containers/com.pvieito.ContainerMigrationExploitApp/
rm -rf ~/Library/Containers/com.pvieito.CalendarExploit/
rm -rf ~/Library/Containers/com.pvieito.MailContactsExploit/

# Reset TCC permissions:
tccutil reset All com.pvieito.ContainerMigrationExpectedApp

# Create secret in Documents folder:
uuidgen > ~/Documents/.my-secret.txt

# To avoid alerts when the files are removed:
killall Mail Calendar Contacts contactsd

# Backup & restore sensitive files:
cp ~/Library/Safari/History.db ~/Library/Safari/History.db.bak
cp ~/Library/Safari/History.db.bak ~/Library/Safari/History.db
cp ~/Library/Calendars/Calendar.sqlitedb ~/Library/Calendars/Calendar.sqlitedb.bak
cp ~/Library/Calendars/Calendar.sqlitedb.bak ~/Library/Calendars/Calendar.sqlitedb
cp ~/Library/Application\ Support/AddressBook/AddressBook-v22.abcddb ~/Library/Application\ Support/AddressBook/AddressBook-v22.abcddb.bak
cp ~/Library/Application\ Support/AddressBook/AddressBook-v22.abcddb.bak ~/Library/Application\ Support/AddressBook/AddressBook-v22.abcddb
cp ~/Library/Application\ Support/MailRecents-v4.abcdmr ~/Library/Application\ Support/AddressBook/MailRecents-v4.abcdmr.bak
cp ~/Library/Application\ Support/AddressBook/MailRecents-v4.abcdmr.bak ~/Library/Application\ Support/AddressBook/MailRecents-v4.abcdmr
cp ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/recentSearches.plist ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/recentSearches.plist.bak
cp ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/recentSearches.plist.bak ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/recentSearches.plist
cp ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/Envelope\ Index ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/Envelope\ Index.bak
cp ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/Envelope\ Index.bak ~/Library/Containers/com.apple.mail/Data/Library/Mail/V10/MailData/Envelope\ Index
